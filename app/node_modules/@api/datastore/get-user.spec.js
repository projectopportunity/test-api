/* eslint-env mocha */
'use strict'

const hash = require('@api/utils/hash')

const T = require('./index.js')
const CONNECTION_STRING = 'sqlite::memory:'

let instance

describe('the datastore module', () => {
  before(() => {
    instance = T()
    return instance.reset()
  })

  it('should have a property called "getUser"', () => {
    expect(instance).to.have.property('getUser')
  })

  describe('the "getUser" property', () => {
    const ERR_INVALID_INPUT = 'Please provide a non-empty string'

    it('should be a function', () => {
      const expected = 'function'
      const actual = typeof instance.getUser
      expect(actual).to.equal(expected)
    })
    
    it('should throw an error if no parameter value is provided', () => {
      const result = instance.getUser()
      return expect(result).to.be.rejectedWith(ERR_INVALID_INPUT)
    })

    it('should throw an error if the param is not a string', () => {
      const badValues = ['', {}, null ]
      
      return Promise.all(
        badValues.map((value) => {
          return expect(instance.getUser(value)).to.be.rejectedWith(ERR_INVALID_INPUT)
        })
      )
    })

    describe('the returned value', () => {
      context('when the init method has not been called', () => {
        it('should be rejected', () => {
          const result = instance.getUser('get-user-username')
          return expect(result).to.be.rejectedWith('Please call init first')
        })
      })

      context('when the init method has been called', () => {
        let result

        before(async () => {
          await instance.init(CONNECTION_STRING)
          
          await instance.createUser({
            name: {
              first: 'get-user-first',
              last: 'get-user-last'
            },
            username: 'get-user-username',
            password: 'get-user-password'
          })

          result = await instance.getUser('get-user-username')
        })

        it('should resolve to an object', () => {
          expect(result).to.be.an('object')
        })

        describe('the returned object', () => {
          it('should have the expected properties', async () => {
            const expected = [
              'first',
              'last',
              'username',
              'password'
            ]
            const actual = Object.keys(result)

            expect(actual).to.have.members(expected)
          })

          describe('the "first" property', () => {
            it('should have the expected value', () => {
              const expected = 'first'
              const actual = result.first

              expect(actual).to.equal(expected)
            })

          })

          describe('the "last" property', () => {
            it('should have the expected value', () => {
              const expected = 'last'
              const actual = result.last

              expect(actual).to.equal(expected)
            })
          })  

          describe('the "username" property', () => {
            it('should have the expected value', () => {
              const expected = 'get-user-username'
              const actual = result.username

              expect(actual).to.equal(expected)
            })
          })

          describe('the "password" property', () => {
            it('should have the expected value', () => {
              const expected = hash.hashPattern
              const actual = result.password

              expect(actual).to.match(expected)
            })
          })
        })     
      })
    })
  })
})
