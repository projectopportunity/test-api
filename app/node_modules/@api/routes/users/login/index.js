const dataStore = require('@api/datastore')()
const hash = require('@api/utils/hash')

module.exports = (req, res, next) => {
  const validationErrorMessages = []

  /**
   * The list of fields that must be in the request body.
   * @type {Array}
   */
  const requiredFields = [
    'emailAddress',
    'password'
  ]

  /**
   * Verify that all of the required fields are present and have a non-blank
   * value.
   */
  requiredFields.forEach((field) => {
    if (
      /**
       * does the field exist?
       */
      !req.body[field] ||

      /**
       * is the value a string?
       */
      typeof req.body[field] !== 'string' ||

      /**
       * is it more than just white space?
       */
      req.body[field].trim().length === 0
    ) {
      validationErrorMessages.push(`missing required field ${field}`)
    }
  })

  if (validationErrorMessages.length > 0) {
    const err = new Error('')
    err.validationErrorMessages = validationErrorMessages
    throw err
  }

  // get users password hash.
  // compare password to hash. (compareToHash)
  // if it does not match, throw an error!
  // if it does match, call next(). Respond firstName, lastName
 
  dataStore.getUser(req.body.emailAddress)
    .then((userInfo) => {
      const isValidCredentials = hash.compareToHash(req.body.password, userInfo.password)

      if (isValidCredentials) {
        next()
      } else {
        next(new Error('invalid login'))
      }
    })
    .catch((err) => {
      next(err)
    })
}
